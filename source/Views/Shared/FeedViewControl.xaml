<controls:PluginUserControl x:Class="FriendsAchievementFeed.Views.Shared.FeedViewControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="clr-namespace:Playnite.SDK.Controls;assembly=Playnite.SDK"
    xmlns:local="clr-namespace:FriendsAchievementFeed.Views.Shared"
    xmlns:svc="clr-namespace:FriendsAchievementFeed.Services"
    mc:Ignorable="d"
    d:DesignHeight="600"
    d:DesignWidth="800">

    <controls:PluginUserControl.Resources>
        <local:UtcToLocalConverter x:Key="UtcToLocalConverter" />
    </controls:PluginUserControl.Resources>

    <Grid Margin="12">
        <Grid.RowDefinitions>
            <!-- Filters -->
            <RowDefinition Height="Auto" />
            <!-- Status -->
            <RowDefinition Height="Auto" />
            <!-- Progress -->
            <RowDefinition Height="Auto" />
            <!-- List -->
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- ROW 0: Filters + buttons -->
        <Grid Grid.Row="0" Margin="0,0,0,8">
            <!-- Rows: label / input+buttons / game / label / input -->
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />   <!-- Friend label -->
                <RowDefinition Height="Auto" />   <!-- Friend input + buttons -->
                <RowDefinition Height="Auto" />   <!-- Game filter (optional) -->
                <RowDefinition Height="Auto" />   <!-- Achievement label -->
                <RowDefinition Height="Auto" />   <!-- Achievement input -->
            </Grid.RowDefinitions>

            <!-- Columns: filters area + buttons -->
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />    <!-- Filters -->
                <ColumnDefinition Width="Auto" /> <!-- Buttons -->
            </Grid.ColumnDefinitions>

            <!-- Friend label (own row) -->
            <TextBlock Grid.Row="0"
                       Grid.Column="0"
                       Text="{DynamicResource LOCFriendsAchFeed_Feed_Label_Friend}"
                       Margin="0,0,0,2"
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource TextBrushDarker}" />

            <!-- Friend input + clear button -->
            <Grid Grid.Row="1" Grid.Column="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />    <!-- Combo -->
                    <ColumnDefinition Width="30" />   <!-- Fixed space for clear button -->
                </Grid.ColumnDefinitions>

                <ComboBox x:Name="FriendFilterCombo"
                          Grid.Column="0"
                          ItemsSource="{Binding FriendFilters}"
                          Text="{Binding FriendSearchText, UpdateSourceTrigger=PropertyChanged}"
                          IsEditable="True"
                          IsTextSearchEnabled="True"
                          Height="28"
                          Padding="8,2,8,2"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Center" />

                <!-- Clear button -->
                <Button Grid.Column="1"
                        Content="Ã—"
                        Padding="0"
                        Margin="4,0,0,0"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Click="FriendClearButton_Click">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding FriendSearchText}" Value="">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding FriendSearchText}" Value="{x:Null}">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
            </Grid>

            <!-- Buttons: same row as Friend input, heights bound to the combo -->
            <StackPanel Grid.Row="1"
                        Grid.Column="1"
                        Orientation="Horizontal"
                        Margin="50,0,0,0"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Center">
                <Button x:Name="RefreshButton"
                    Content="{DynamicResource LOCFriendsAchFeed_Feed_Button_Refresh}"
                    Focusable="False"
                    FontSize="12"
                    Width="64"
                    Margin="0,0,10,0"
                    ToolTip="{DynamicResource LOCFriendsAchFeed_Feed_Button_Refresh_Tooltip}"
                    Command="{Binding TriggerRebuildCommand}"
                    Height="{Binding ElementName=FriendFilterCombo, Path=ActualHeight}" />
                <Button x:Name="CancelRebuildButton"
                    Content="{DynamicResource LOCFriendsAchFeed_Feed_Button_Cancel}"
                    Focusable="False"
                    FontSize="12"
                    Width="64"
                    Margin="0,0,50,0"
                    ToolTip="{DynamicResource LOCFriendsAchFeed_Feed_Button_Cancel_Tooltip}"
                    Command="{Binding CancelRebuildCommand}"
                    Height="{Binding ElementName=FriendFilterCombo, Path=ActualHeight}" />
            </StackPanel>

            <!-- Game filter row (optional, provided via ExtraFiltersContent) -->
            <ContentPresenter Grid.Row="2"
                              Grid.Column="0"
                              Margin="0,4,0,0"
                              HorizontalAlignment="Stretch"
                              Content="{Binding ExtraFiltersContent,
                                        RelativeSource={RelativeSource AncestorType=local:FeedViewControl}}">
                <ContentPresenter.Style>
                    <Style TargetType="ContentPresenter">
                        <Setter Property="Visibility" Value="Visible" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding ExtraFiltersContent,
                                                          RelativeSource={RelativeSource AncestorType=local:FeedViewControl}}"
                                         Value="{x:Null}">
                                <Setter Property="Visibility" Value="Collapsed" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ContentPresenter.Style>
            </ContentPresenter>

            <!-- Achievement label (own row) -->
            <TextBlock Grid.Row="3"
                       Grid.Column="0"
                       Text="{DynamicResource LOCFriendsAchFeed_Feed_Label_Achievement}"
                       Margin="0,4,0,2"
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource TextBrushDarker}" />

            <!-- Achievement input -->
            <Grid Grid.Row="4" Grid.Column="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />    <!-- TextBox -->
                    <ColumnDefinition Width="30" />   <!-- Fixed space for clear button -->
                </Grid.ColumnDefinitions>

                <TextBox Grid.Column="0"
                         Text="{Binding AchievementSearchText, UpdateSourceTrigger=PropertyChanged}"
                         Height="28"
                         Padding="8,2,8,2"
                         ToolTip="{DynamicResource LOCFriendsAchFeed_Feed_Tooltip_SearchAchievement}"
                         VerticalContentAlignment="Center"
                         HorizontalAlignment="Stretch" />

                <Button Grid.Column="1"
                        Content="Ã—"
                        Padding="0"
                        Margin="4,0,0,0"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Click="AchievementClearButton_Click">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding AchievementSearchText}" Value="">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding AchievementSearchText}" Value="{x:Null}">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
            </Grid>
        </Grid>

        <!-- ROW 1: Status -->
        <StackPanel Grid.Row="1"
                    Orientation="Horizontal"
                    Margin="0,0,0,4">
            <TextBlock Text="{Binding StatusMessage}"
                       Foreground="{DynamicResource TextBrush}"
                       Opacity="0.75"
                       TextWrapping="Wrap" />
            <TextBlock Text="  " />
            <TextBlock Text="{DynamicResource LOCFriendsAchFeed_Feed_Status_CacheLast}"
                       Foreground="{DynamicResource TextBrushDarker}"
                       Opacity="0.7"
                       VerticalAlignment="Center" />
            <TextBlock Text = " "
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource TextBrushDarker}"
                       Opacity="0.7" />
            <TextBlock Text="{Binding CacheLastUpdatedText}"
                       Foreground="{DynamicResource TextBrush}"
                       Opacity="0.7"
                       VerticalAlignment="Center" />
        </StackPanel>

        <!-- ROW 2: Progress -->
        <ProgressBar Grid.Row="2"
                     Value="{Binding ProgressPercent}"
                     Height="20"
                     Margin="0,0,0,8"
                     Minimum="0"
                     Maximum="100">
            <ProgressBar.Style>
                <Style TargetType="ProgressBar"
                       BasedOn="{StaticResource {x:Type ProgressBar}}">
                    <Setter Property="Visibility" Value="Collapsed" />
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding ShowProgress}" Value="True">
                            <Setter Property="Visibility" Value="Visible" />
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </ProgressBar.Style>
        </ProgressBar>

        <!-- ROW 3: Scrollable feed with virtualization -->
        <Border Grid.Row="3"
                BorderBrush="{DynamicResource NormalBorderBrush}"
                BorderThickness="1"
                Background="Transparent"
                CornerRadius="4"
                Padding="0">
            <ListBox ItemsSource="{Binding GroupedEntries}"
                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                     ScrollViewer.CanContentScroll="True"
                     SelectionMode="Single"
                     VirtualizingStackPanel.IsVirtualizing="True"
                     VirtualizingStackPanel.VirtualizationMode="Recycling"
                     VirtualizingStackPanel.ScrollUnit="Pixel">

                <!-- Remove outer ListBoxItem chrome / highlight -->
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="Margin" Value="0" />
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListBoxItem">
                                    <ContentPresenter />
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.ItemContainerStyle>

                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Margin="6"
                                Padding="8"
                                Background="{DynamicResource ControlBackgroundBrush}"
                                BorderBrush="{DynamicResource NormalBorderBrush}"
                                BorderThickness="1"
                                CornerRadius="3">
                            <StackPanel>

                                <!-- Header: avatar + "<name> achieved in <game>" + date -->
                                <StackPanel Orientation="Horizontal"
                                            Margin="0,0,0,4">
                                    <Image Width="{Binding DataContext.FriendAvatarSize, RelativeSource={RelativeSource AncestorType=local:FeedViewControl}}"
                                           Height="{Binding DataContext.FriendAvatarSize, RelativeSource={RelativeSource AncestorType=local:FeedViewControl}}"
                                           Source="{Binding FriendAvatarUrl}"
                                           VerticalAlignment="Center" />
                                    <StackPanel Margin="8,0,0,0">
                                        <!-- Main header line -->
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding FriendPersonaName}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextBrush}"
                                                       Cursor="Hand"
                                                       MouseLeftButtonUp="FriendName_Click" />
                                            <TextBlock Text="{DynamicResource LOCFriendsAchFeed_Feed_Header_Achieved}"
                                                       Margin="4,0,0,0"
                                                       Foreground="{DynamicResource TextBrush}"
                                                       Opacity="0.6" />
                                            <TextBlock Text=" "
                                                        Foreground="{DynamicResource TextBrush}"
                                                        Opacity="0.6"/>
                                            <TextBlock Text="{DynamicResource LOCFriendsAchFeed_Feed_Header_In}"
                                                       Foreground="{DynamicResource TextBrush}"
                                                       Opacity="0.6">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility"
                                                                Value="Collapsed" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ShowGameName}"
                                                                         Value="True">
                                                                <Setter Property="Visibility"
                                                                        Value="Visible" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                            <TextBlock Text="{Binding GameName}"
                                                       Margin="4,0,0,0"
                                                       Foreground="{DynamicResource TextBrush}"
                                                       Cursor="Hand"
                                                       MouseLeftButtonUp="GameName_Click">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility"
                                                                Value="Collapsed" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ShowGameName}"
                                                                         Value="True">
                                                                <Setter Property="Visibility"
                                                                        Value="Visible" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </StackPanel>

                                        <!-- Date under the header -->
                                        <TextBlock Text="{Binding SubheaderText}"
                                                   Foreground="{DynamicResource TextBrush}"
                                                   Opacity="0.6"
                                                   FontSize="12" />
                                    </StackPanel>
                                </StackPanel>

                                <!-- Inner list: achievements, does NOT steal scroll -->
                                <ItemsControl ItemsSource="{Binding Achievements}"
                                                Margin="0,4,0,0">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <!-- Row root: hover + cursor on the BORDER, layout inside -->
                                            <Border Margin="0,1,0,1"
                                                Padding="3"
                                                CornerRadius="3"
                                                BorderBrush="{DynamicResource NormalBorderBrush}"
                                                BorderThickness="0">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="Background" Value="Transparent" />
                                                        <Setter Property="Cursor" Value="Arrow" />
                                                        <Style.Triggers>
                                                            <!-- Hover highlight to mimic selection -->
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="#33FFFFFF" />
                                                            </Trigger>

                                                            <DataTrigger Binding="{Binding HideDescription}"
                                                                            Value="True">
                                                                <Setter Property="Cursor" Value="Hand" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>

                                                <!-- Actual content grid: handles the click -->
                                                <Grid MouseLeftButtonUp="AchievementItem_Click">
                                                    <!-- 3-column grid:
                                                        [0] padlock column (avatar-width, aligned under avatar)
                                                        [1] icon
                                                        [2] text -->
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="{Binding DataContext.FriendAvatarSize,
                                                                                        RelativeSource={RelativeSource AncestorType=local:FeedViewControl}}" />
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>

                                                    <!-- Padlock aligned under avatar, visible whenever HideDescription is true -->
                                                    <TextBlock Grid.Column="0"
                                                               Text="ðŸ”’"
                                                               VerticalAlignment="Center"
                                                               HorizontalAlignment="Center"
                                                               Foreground="{DynamicResource TextBrush}"
                                                               Opacity="0.85">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Visibility" Value="Hidden" />
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding HideDescription}"
                                                                                 Value="True">
                                                                        <Setter Property="Visibility" Value="Visible" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>

                                                    <!-- Achievement icon -->
                                                    <Grid Grid.Column="1"
                                                          Width="{Binding DataContext.AchievementIconSize, RelativeSource={RelativeSource AncestorType=local:FeedViewControl}}"
                                                          Height="{Binding DataContext.AchievementIconSize, RelativeSource={RelativeSource AncestorType=local:FeedViewControl}}"
                                                          Margin="8,0,8,0"
                                                          VerticalAlignment="Center">
                                                        <!-- Locked/hidden icon (visible when not revealed) -->
                                                        <Image Source="{Binding AchievementIconUrl}"
                                                               Stretch="Uniform"
                                                               VerticalAlignment="Center">
                                                            <Image.Style>
                                                                <Style TargetType="Image">
                                                                    <Setter Property="Opacity" Value="1" />
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsRevealed}" Value="True">
                                                                            <Setter Property="Opacity" Value="0" />
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Image.Style>
                                                        </Image>

                                                        <!-- Unlocked icon (visible when revealed) -->
                                                        <Image Source="{Binding AchievementIconUnlockedUrl}"
                                                               Stretch="Uniform"
                                                               VerticalAlignment="Center">
                                                            <Image.Style>
                                                                <Style TargetType="Image">
                                                                    <Setter Property="Opacity" Value="0" />
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsRevealed}" Value="True">
                                                                            <Setter Property="Opacity" Value="1" />
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Image.Style>
                                                        </Image>
                                                    </Grid>

                                                    <!-- Text + times -->
                                                    <StackPanel Grid.Column="2">
                                                        <TextBlock Text="{Binding AchievementDisplayName}"
                                                                   FontWeight="Bold"
                                                                   Foreground="{DynamicResource TextBrush}"
                                                                   TextWrapping="Wrap" />

                                                        <TextBlock Text="{Binding AchievementDescription}"
                                                                   Foreground="{DynamicResource TextBrush}"
                                                                   Opacity="0.8"
                                                                   FontSize="12"
                                                                   TextWrapping="Wrap"
                                                                   Margin="0,2,0,0">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Visibility" Value="Visible" />
                                                                    <Style.Triggers>
                                                                        <MultiDataTrigger>
                                                                            <MultiDataTrigger.Conditions>
                                                                                <Condition Binding="{Binding HideDescription}"
                                                                                           Value="True" />
                                                                                <Condition Binding="{Binding IsRevealed}"
                                                                                           Value="False" />
                                                                            </MultiDataTrigger.Conditions>
                                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                                        </MultiDataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>

                                                        <!-- Placeholder when description is hidden and not revealed -->
                                                        <TextBlock Text=""
                                                                   Foreground="{DynamicResource TextBrush}"
                                                                   Opacity="0.6"
                                                                   FontSize="12"
                                                                   TextWrapping="Wrap"
                                                                   Margin="0,2,0,0">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                                    <Style.Triggers>
                                                                        <MultiDataTrigger>
                                                                            <MultiDataTrigger.Conditions>
                                                                                <Condition Binding="{Binding HideDescription}"
                                                                                           Value="True" />
                                                                                <Condition Binding="{Binding IsRevealed}"
                                                                                           Value="False" />
                                                                            </MultiDataTrigger.Conditions>
                                                                            <Setter Property="Visibility" Value="Visible" />
                                                                        </MultiDataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>

                                                        <TextBlock Text="{Binding UnlockTime,
                                                                                Converter={StaticResource UtcToLocalConverter},
                                                                                StringFormat={}{0:t}}"
                                                                Foreground="{DynamicResource TextBrush}"
                                                                Opacity="0.6"
                                                                FontSize="11"
                                                                Margin="0,2,0,0" />

                                                        <TextBlock Foreground="{DynamicResource TextBrush}"
                                                                   Opacity="0.6"
                                                                   FontSize="11"
                                                                   Margin="0,2,0,0">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Visibility" Value="Visible" />
                                                                    <Style.Triggers>
                                                                        <!-- Hide when setting disabled -->
                                                                        <DataTrigger Binding="{Binding DataContext.ShowMyUnlockTime, RelativeSource={RelativeSource AncestorType=local:FeedViewControl}}" Value="False">
                                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                                        </DataTrigger>
                                                                        <!-- Hide when there is no unlock time for this entry -->
                                                                        <DataTrigger Binding="{Binding MyUnlockTime}" Value="{x:Null}">
                                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                            <TextBlock.Inlines>
                                                                <Run Text="{DynamicResource LOCFriendsAchFeed_Feed_Label_MyUnlockTime}" />
                                                                <Run Text=" " />
                                                                <Run Text="{Binding MyUnlockTime, Converter={StaticResource UtcToLocalConverter}, StringFormat={}{0:g}}" />
                                                            </TextBlock.Inlines>
                                                        </TextBlock>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Border>
    </Grid>
</controls:PluginUserControl>
